{{ define "main" }}
<section class="archive-page">
    <h1 class="page-title">{{ .Title }}</h1>

    {{ if .Content }}
    <div class="page-intro prose">
        {{ .Content }}
    </div>
    {{ end }}

    {{ $posts := where .Site.RegularPages "Section" "posts" }}

    <div id="active-filter-bar" class="active-filter-bar" style="display: none;">
        <span>Visar inl√§gg om: <strong id="active-filter-name"></strong></span>
        <a href="{{ .Permalink }}" class="clear-filter-btn">‚úï Visa alla inl√§gg</a>
    </div>

    <div class="archive-timeline">
        {{ range $posts }}
        <article class="archive-item"
            data-species="{{ with .Params.species }}{{ delimit (apply . `urlize` `.`) `,` | lower }}{{ end }}">
            <time datetime="{{ .Date.Format `2006-01-02` }}" class="archive-date">
                {{ .Date.Format "2 Jan" }}
            </time>
            <div class="archive-card">
                {{ if .Params.image }}
                <div class="archive-thumb">
                    <img src="{{ .Params.image | relURL }}" alt="{{ .Title }}" loading="lazy">
                </div>
                {{ else }}
                <div class="archive-thumb archive-thumb--fallback">
                    <span class="archive-thumb__date">{{ .Date.Format "2 Jan" }}</span>
                </div>
                {{ end }}
                <div class="archive-card__body">
                    <h2 class="archive-title">
                        <a href="{{ .Permalink }}" class="archive-card__link">{{ .Title }}</a>
                    </h2>
                    {{ with .Params.location }}
                    <span class="archive-location">üìç {{ . }}</span>
                    {{ end }}
                    <p class="archive-summary">{{ with .Description }}{{ . }}{{ else }}{{ .Summary | plainify | truncate
                        120 }}{{ end }}</p>
                    {{ with .Params.species }}
                    <div class="archive-tags">
                        {{ range (first 3 .) }}
                        <a href="?species={{ . | urlize }}" class="archive-tag">{{ . }}</a>
                        {{ end }}
                        {{ if gt (len .) 3 }}
                        <span class="archive-tag archive-tag--more">+{{ sub (len .) 3 }}</span>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
            </div>
        </article>
        {{ end }}
    </div>

    {{ if eq (len $posts) 0 }}
    <p class="empty-state">Inga inl√§gg √§nnu. H√•ll utkik!</p>
    {{ end }}
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const filterSpecies = params.get('species');

        if (filterSpecies) {
            // Show filter bar
            const filterBar = document.getElementById('active-filter-bar');
            const filterName = document.getElementById('active-filter-name');

            // Try to get a nice display name from the URL by capitalizing it (or we can just show the slug if it's tricky)
            // A simple readable format from the slug: replace dashes with spaces, uppercase first letter
            const displayLabel = decodeURIComponent(filterSpecies).replace(/-/g, ' ').replace(/^./, str => str.toUpperCase());

            if (filterBar && filterName) {
                filterName.textContent = displayLabel;
                filterBar.style.display = 'flex';
            }

            // Filter items
            const items = document.querySelectorAll('.archive-item');
            let visibleCount = 0;

            items.forEach(item => {
                const speciesStr = item.getAttribute('data-species') || '';
                const speciesList = speciesStr.split(',').map(s => s.trim().toLowerCase());

                if (speciesList.includes(filterSpecies.toLowerCase())) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Show empty message if nothing matches
            if (visibleCount === 0) {
                const timeline = document.querySelector('.archive-timeline');
                if (timeline) {
                    timeline.innerHTML = '<p class="empty-state">Inga inl√§gg hittades f√∂r ' + displayLabel + '.</p>';
                }
            }
        }
    });
</script>
{{ end }}