{{ define "main" }}
<div class="atlas-page">
    <div class="atlas-disclaimer">
        üî¨ <em>F√•gelatlasen f√∂r √Östorps kommun √§r ett p√•g√•ende projekt under utveckling. Data och inneh√•ll byggs upp
            successivt under f√•gel√•ret 2026.</em>
    </div>

    {{/* ‚îÄ‚îÄ DATA COLLECTION ‚îÄ‚îÄ */}}
    {{ $speciesName := .Title }}
    {{ $posts := .Pages }}

    {{/* Checklist data */}}
    {{ $checklist := site.Data.checklist_2026 | default (dict) }}
    {{ $checklistObs := index $checklist "observations" | default slice }}
    {{ $tickDate := "" }}
    {{ $tickNumber := 0 }}
    {{ $tickLocation := "" }}
    {{ $counter := 0 }}
    {{ range $checklistObs }}
    {{ $counter = add $counter 1 }}
    {{ if eq .species $speciesName }}
    {{ if eq $tickDate "" }}
    {{ $tickDate = .date }}
    {{ $tickNumber = $counter }}
    {{ $tickLocation = .location }}
    {{ end }}
    {{ end }}
    {{ end }}

    {{/* Species guide data (Artportalen stats) */}}
    {{ $guide := site.Data.species_guide | default (dict) }}
    {{ $guideSpecies := index $guide "species" | default slice }}
    {{ $latinName := "" }}
    {{ $totalObs := 0 }}
    {{ $monthData := slice 0 0 0 0 0 0 0 0 0 0 0 0 }}
    {{ range $guideSpecies }}
    {{ if eq .name $speciesName }}
    {{ $latinName = .latin }}
    {{ $totalObs = .total }}
    {{ $monthData = .months }}
    {{ end }}
    {{ end }}

    {{/* Collect images */}}
    {{ $allImages := slice }}
    {{ range $posts }}
    {{ $post := . }}
    {{ $content := .RawContent }}
    {{ $imgRegex := `<img[^>]+src=["']([^"']+)["'][^>]*>` }}
        {{ $mdRegex := `!\[.*?\]\((.*?)\)` }}
        {{ range (findRE $imgRegex $content) }}
        {{ $url := replaceRE `.*src=["']([^"']+)["'].*` "$1" . }}
        {{ if not (in $url "hitta-hit") }}
        {{ $allImages = $allImages | append (dict "url" $url "post" $post) }}
        {{ end }}
        {{ end }}
        {{ range (findRE $mdRegex $content) }}
        {{ $url := replaceRE `!\[.*?\]\((.*?)\)` "$1" . }}
        {{ if not (in $url "hitta-hit") }}
        {{ $allImages = $allImages | append (dict "url" $url "post" $post) }}
        {{ end }}
        {{ end }}
        {{ with .Params.image }}
        {{ $allImages = $allImages | append (dict "url" . "post" $post) }}
        {{ end }}
        {{ end }}

        {{/* Collect unique locations */}}
        {{ $locations := slice }}
        {{ range $posts }}
        {{ with .Params.locations }}
        {{ range . }}
        {{ if not (in $locations .name) }}
        {{ $locations = $locations | append .name }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ with .Params.location }}
        {{ if not (in $locations .) }}
        {{ $locations = $locations | append . }}
        {{ end }}
        {{ end }}
        {{ end }}

        {{/* Collect months with posts (for fenology) */}}
        {{ $postMonths := slice 0 0 0 0 0 0 0 0 0 0 0 0 }}
        {{ range $posts }}
        {{ $m := sub (int (.Date.Format "1")) 1 }}
        {{ $postMonths = $postMonths | append $m }}
        {{ end }}

        {{/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}}
        <div class="species-page-header">
            <h1 class="species-page-title">{{ $speciesName }}</h1>
            {{ with $latinName }}
            <p class="species-page-latin"><em>{{ . }}</em></p>
            {{ end }}
        </div>

        {{/* ‚îÄ‚îÄ LAYOUT: Two columns on desktop ‚îÄ‚îÄ */}}
        <div class="species-page-layout">

            {{/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */}}
            <aside class="species-sidebar">
                <div class="species-fact-card">
                    <h3>üìå Ditt F√•gel√•r</h3>
                    {{ if ne $tickDate "" }}
                    <div class="species-fact-row">
                        <span class="species-fact-label">Kryss</span>
                        <span class="species-fact-value">#{{ $tickNumber }} av 150</span>
                    </div>
                    <div class="species-fact-row">
                        <span class="species-fact-label">F√∂rsta obs</span>
                        <span class="species-fact-value">{{ $tickDate }}</span>
                    </div>
                    {{ with $tickLocation }}
                    <div class="species-fact-row">
                        <span class="species-fact-label">Plats</span>
                        <span class="species-fact-value">{{ . }}</span>
                    </div>
                    {{ end }}
                    {{ else }}
                    <p class="species-fact-pending">Ej kryssad 2026</p>
                    {{ end }}
                </div>

                {{ if gt $totalObs 0 }}
                <div class="species-fact-card">
                    <h3>üìä Artportalen (alla √•r)</h3>
                    <div class="species-fact-row">
                        <span class="species-fact-label">Rapporter</span>
                        <span class="species-fact-value">{{ $totalObs }}</span>
                    </div>
                    <div class="species-fact-row">
                        <span class="species-fact-label">Kommun</span>
                        <span class="species-fact-value">√Östorp</span>
                    </div>
                </div>
                {{ end }}

                {{ if gt (len $locations) 0 }}
                <div class="species-fact-card">
                    <h3>üó∫Ô∏è D√§r vi setts</h3>
                    <p class="species-locations-list">{{ delimit $locations " ¬∑ " }}</p>
                </div>
                {{ end }}
            </aside>

            {{/* ‚îÄ‚îÄ MAIN COLUMN ‚îÄ‚îÄ */}}
            <div class="species-main-col">

                {{/* Mini-gallery with lightbox */}}
                {{ if gt (len $allImages) 0 }}
                <section class="species-section">
                    <h2>Bilder</h2>
                    <div class="species-mini-gallery">
                        {{ range $allImages }}
                        <div class="species-gallery-thumb" onclick="openLightbox('{{ .url }}', '{{ $speciesName }}')">
                            <img src="{{ .url }}" alt="{{ $speciesName }}" loading="lazy">
                        </div>
                        {{ end }}
                    </div>
                </section>
                {{ end }}

                {{/* Fenology Chart */}}
                {{ if gt $totalObs 0 }}
                <section class="species-section">
                    <h2>N√§rvaro i √Östorps kommun</h2>
                    <p class="species-chart-caption">Rapporter per m√•nad till Artportalen (alla √•r)</p>
                    <div class="species-fenology" id="fenology-chart">
                        {{ $months := slice "J" "F" "M" "A" "M" "J" "J" "A" "S" "O" "N" "D" }}
                        {{ $maxVal := 1 }}
                        {{ range $monthData }}{{ if gt (int .) (int $maxVal) }}{{ $maxVal = . }}{{ end }}{{ end }}
                        {{ range $i, $label := $months }}
                        {{ $val := index $monthData $i }}
                        {{ $pct := 0 }}{{ if gt (int $maxVal) 0 }}{{ $pct = div (mul (int $val) 100) (int $maxVal) }}{{
                        end }}
                        <div class="fenology-bar-wrap">
                            <div class="fenology-bar" style="height: {{ $pct }}%;" title="{{ $val }} rapporter"></div>
                            <span class="fenology-label">{{ $label }}</span>
                        </div>
                        {{ end }}
                    </div>
                </section>
                {{ end }}

                {{/* Related posts */}}
                {{ if gt (len $posts) 0 }}
                <section class="species-section">
                    <h2>F√§ltdagboken</h2>
                    <div class="species-posts-list">
                        {{ range $posts.ByDate.Reverse }}
                        <a href="{{ .Permalink }}" class="species-post-item">
                            <time>{{ .Date.Format "2 Jan 2006" }}</time>
                            <span class="species-post-title">{{ .Title }}</span>
                            {{ with .Params.location }}
                            <span class="species-post-location">üìç {{ . }}</span>
                            {{ end }}
                        </a>
                        {{ end }}
                    </div>
                </section>
                {{ end }}

            </div>
        </div>

        <div class="species-back-link">
            <a href="{{ " species/" | absURL }}">‚Üê Tillbaka till F√•gelatlasen</a>
        </div>
</div>
{{ end }}