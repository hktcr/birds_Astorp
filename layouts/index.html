{{ define "main" }}
<!-- Professionell mjuk startsida -->
<section class="home-hero">
    <div class="home-container">
        <!-- Stor logga centrerad -->
        <div class="hero-logo">
            <img src="{{ `images/logo-fagelaret-2026.png` | relURL }}" alt="Ett √•r med f√•glar ‚Äî √Östorp 2026">
        </div>

        <!-- Progressbar som termometer -->
        <div class="hero-progress">
            <div class="progress-header">
                <span class="progress-label">√Örslista</span>
                <span class="progress-count"><span id="species-count">‚Äî</span> av 150 arter</span>
            </div>
            <div class="thermometer">
                <div class="thermometer-scale">
                    <span class="scale-mark" style="left: 0%">0</span>
                    <span class="scale-mark" style="left: 33%">50</span>
                    <span class="scale-mark" style="left: 66%">100</span>
                    <span class="scale-mark" style="left: 100%">150</span>
                </div>
                <div class="thermometer-bar">
                    <div class="thermometer-fill" id="progress-fill"></div>
                </div>
            </div>
            <div class="latest-species" id="latest-species"></div>
        </div>

        <!-- Senaste notis (minimal stil) -->
        {{ $latest := first 1 (where .Site.RegularPages "Section" "posts") }}
        {{ range $latest }}
        <a href="{{ .RelPermalink }}" class="latest-post-link">
            üìù <strong>{{ .Title }}</strong> <span class="latest-post-meta">‚Äî {{ .Date | time.Format "2 jan" }}</span>
        </a>
        {{ end }}

        <!-- Observationssp√•r / Tidslinje -->
        <div class="observation-trail">
            <h2 class="trail-title">Observationssp√•r</h2>
            <div class="trail-timeline" id="trail-timeline">
                <!-- Fylls av JavaScript -->
            </div>
        </div>

    </div>
</section>
{{ end }}

{{ define "scripts" }}
<script>
    const YEAR_GOAL = 150;

    // Mappa datum till notiser (genereras av Hugo)
    const postsByDate = {};
    { { $allPosts:= where.Site.RegularPages "Section" "posts" } }
    { { range $allPosts } }
    postsByDate["{{ .Date.Format "2006-01-02" }}"] = "{{ .RelPermalink }}";
    { { end } }

    // DATA LOADING
    const data = {{ index .Site.Data "checklist-2026" | jsonify | safeJS }};

    function initDashboard() {
        if (!data || !data.observations) {
            console.error("Ingen data laddad");
            return;
        }

        const uniqueSpecies = new Set(data.observations.map(function (o) { return o.species; }));
        const speciesCount = uniqueSpecies.size;

        var countEl = document.getElementById('species-count');
        if (countEl) countEl.textContent = speciesCount;

        var percentage = (speciesCount / YEAR_GOAL) * 100;
        var fill = document.getElementById('progress-fill');
        if (fill) {
            fill.style.width = Math.min(percentage, 100) + '%';
            var hue = 45;
            if (percentage > 20) {
                hue = 45 + ((percentage - 20) / 80) * 75;
            }
            fill.style.backgroundColor = 'hsl(' + hue + ', 90%, 50%)';
        }

        // Senast kryssad
        if (data.observations.length > 0) {
            var latest = data.observations[data.observations.length - 1];
            var latestEl = document.getElementById('latest-species');
            if (latestEl) {
                latestEl.innerHTML = '<span class="latest-label">Senast kryssad:</span> <strong>' + latest.species + '</strong> <span class="latest-meta">(' + latest.location + ', ' + new Date(latest.date).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) + ')</span>';
            }
        }

        // Observationssp√•r
        var byDate = {};
        data.observations.forEach(function (obs) {
            if (!byDate[obs.date]) {
                byDate[obs.date] = { species: [], locations: [] };
            }
            byDate[obs.date].species.push(obs.species);
            if (byDate[obs.date].locations.indexOf(obs.location) === -1) {
                byDate[obs.date].locations.push(obs.location);
            }
        });

        var dates = Object.keys(byDate).sort(function (a, b) { return new Date(b) - new Date(a); });
        var trailEl = document.getElementById('trail-timeline');

        if (trailEl) {
            var html = '';
            dates.forEach(function (date, i) {
                var info = byDate[date];
                var dateObj = new Date(date);
                var day = dateObj.getDate();
                var month = dateObj.toLocaleDateString('sv-SE', { month: 'short' });
                var locations = info.locations.join(', ');
                var isLast = i === dates.length - 1;

                var postLink = postsByDate[date];
                var hasPost = postLink ? ' has-post' : '';
                var postIcon = postLink ? ' üìù' : '';
                var dateTag = postLink ? 'a href="' + postLink + '"' : 'span';
                var dateTagClose = postLink ? 'a' : 'span';

                html += '<div class="trail-item' + (i === 0 ? ' trail-item-latest' : '') + '">';
                html += '<div class="trail-line' + (isLast ? ' trail-line-end' : '') + '"></div>';
                html += '<div class="trail-dot"></div>';
                html += '<div class="trail-content">';
                html += '<' + dateTag + ' class="trail-date' + hasPost + '"><span class="trail-day">' + day + '</span><span class="trail-month">' + month + '</span>' + postIcon + '</' + dateTagClose + '>';
                html += '<div class="trail-details"><span class="trail-species">' + info.species.join(', ') + '</span>';
                html += '<span class="trail-location">' + locations + '</span></div>';
                html += '</div></div>';
            });
            trailEl.innerHTML = html;
        }
    }

    initDashboard();
</script>
{{ end }}