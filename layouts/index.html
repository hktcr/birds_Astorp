{{/*
INDEX.HTML - Startsida för Fågelåret i Åstorp

VIKTIGT: Hugo-syntax måste vara EXAKT dubbelklammer UTAN mellanslag!
FEL: klammer-mellanslag-klammer range
RATT: dubbelklammer range dubbelklammer
*/}}

{{ define "main" }}
<!-- Professionell mjuk startsida -->
<section class="home-hero">
    <div class="home-container">
        <!-- Stor logga centrerad -->
        <div class="hero-logo">
            <img src="{{ `images/logo-fagelaret-2026.png` | relURL }}" alt="Ett år med fåglar — Åstorp 2026">
        </div>

        <!-- Progressbar som termometer -->
        <div class="hero-progress">
            <div class="progress-header">
                <span class="progress-label">Årslista</span>
                <span class="progress-count"><span id="species-count">—</span> av 150 arter</span>
            </div>
            <div class="thermometer">
                <div class="thermometer-scale">
                    <span class="scale-mark" style="left: 0%">0</span>
                    <span class="scale-mark" style="left: 33%">50</span>
                    <span class="scale-mark" style="left: 66%">100</span>
                    <span class="scale-mark" style="left: 100%">150</span>
                </div>
                <div class="thermometer-bar">
                    <div class="thermometer-fill" id="progress-fill"></div>
                </div>
            </div>
            <div class="latest-species" id="latest-species"></div>
        </div>

        <!-- Senaste notis (rundad ruta utan emoji) -->
        {{ $latest := first 1 (where .Site.RegularPages "Section" "posts") }}
        {{ range $latest }}
        <a href="{{ .RelPermalink }}" class="latest-post-box">
            <span class="latest-post-label">Senaste notis</span>
            <span class="latest-post-title">{{ .Title }}</span>
            <span class="latest-post-date">{{ .Date | time.Format "2 jan" }}</span>
        </a>
        {{ end }}

        <!-- Observationsspår / Tidslinje -->
        <div class="observation-trail">
            <h2 class="trail-title">Observationsspår</h2>
            <div class="trail-timeline" id="trail-timeline">
                <!-- Fylls av JavaScript -->
            </div>
        </div>

    </div>
</section>
{{ end }}

{{ define "scripts" }}
<script>
    // Dashboard-logik
    var YEAR_GOAL = 150;

    // Mappa datum till notiser (genereras av Hugo vid byggtid)
    var postsByDate = {};
    {{ range where .Site.RegularPages "Section" "posts" }}
    postsByDate["{{ .Date.Format "2006-01-02" }}"] = "{{ .RelPermalink }}";
    {{ end }}

    // DATA: Inbäddas vid byggtid
    var data = {{ index .Site.Data "checklist-2026" | jsonify | safeJS }};

    function initDashboard() {
        if (!data || !data.observations) {
            console.error("Ingen data laddad");
            return;
        }

        var uniqueSpecies = {};
        data.observations.forEach(function (o) { uniqueSpecies[o.species] = true; });
        var speciesCount = Object.keys(uniqueSpecies).length;

        var countEl = document.getElementById('species-count');
        if (countEl) countEl.textContent = speciesCount;

        var percentage = (speciesCount / YEAR_GOAL) * 100;
        var fill = document.getElementById('progress-fill');
        if (fill) {
            fill.style.width = Math.min(percentage, 100) + '%';
            var hue = 45;
            if (percentage > 20) {
                hue = 45 + ((percentage - 20) / 80) * 75;
            }
            fill.style.backgroundColor = 'hsl(' + hue + ', 90%, 50%)';
        }

        if (data.observations.length > 0) {
            var latest = data.observations[data.observations.length - 1];
            var latestEl = document.getElementById('latest-species');
            if (latestEl) {
                latestEl.innerHTML = '<span class="latest-label">Senast kryssad:</span> <strong>' + latest.species + '</strong> <span class="latest-meta">(' + latest.location + ', ' + new Date(latest.date).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) + ')</span>';
            }
        }

        // Bygg observationsspår med ny layout
        // Tilldela löpnummer per unik art i kronologisk ordning
        var speciesNumber = {};
        var nextNumber = 1;
        var byDate = {};
        data.observations.forEach(function (obs) {
            if (!speciesNumber[obs.species]) {
                speciesNumber[obs.species] = nextNumber++;
            }
            if (!byDate[obs.date]) {
                byDate[obs.date] = { species: [], locations: [] };
            }
            byDate[obs.date].species.push(obs.species);
            if (byDate[obs.date].locations.indexOf(obs.location) === -1) {
                byDate[obs.date].locations.push(obs.location);
            }
        });

        var dates = Object.keys(byDate).sort(function (a, b) { return new Date(b) - new Date(a); });
        var trailEl = document.getElementById('trail-timeline');

        if (trailEl) {
            var html = '';
            dates.forEach(function (date, i) {
                var info = byDate[date];
                var dateObj = new Date(date);
                var day = dateObj.getDate();
                var month = dateObj.toLocaleDateString('sv-SE', { month: 'long' });
                var isLast = i === dates.length - 1;
                var postLink = postsByDate[date];

                html += '<div class="trail-item' + (i === 0 ? ' trail-item-latest' : '') + '">';
                html += '<div class="trail-line' + (isLast ? ' trail-line-end' : '') + '"></div>';
                html += '<div class="trail-dot"></div>';
                html += '<div class="trail-content">';

                // Rad 1: Datum (länkat om notis finns)
                if (postLink) {
                    html += '<a href="' + postLink + '" class="trail-date has-post">' + day + ' ' + month + ' ↗</a>';
                } else {
                    html += '<div class="trail-date">' + day + ' ' + month + '</div>';
                }

                // Rad 2: Arter med löpnummer
                var speciesWithNumbers = info.species.map(function (sp) {
                    return '<span class="trail-species-number">#' + speciesNumber[sp] + '</span> ' + sp;
                });
                html += '<div class="trail-species">' + speciesWithNumbers.join(', ') + '</div>';

                // Rad 3: Platser
                html += '<div class="trail-location">' + info.locations.join(' • ') + '</div>';

                html += '</div></div>';
            });
            trailEl.innerHTML = html;
        }
    }

    initDashboard();
</script>
{{ end }}