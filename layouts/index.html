{{ define "main" }}
<!-- Professionell mjuk startsida -->
<section class="home-hero">
    <div class="home-container">
        <!-- Stor logga centrerad -->
        <div class="hero-logo">
            <img src="{{ `images/logo-fagelaret-2026.png` | relURL }}" alt="Ett √•r med f√•glar ‚Äî √Östorp 2026">
        </div>

        <!-- Progressbar som termometer -->
        <div class="hero-progress">
            <div class="progress-header">
                <span class="progress-label">√Örslista</span>
                <span class="progress-count"><span id="species-count">‚Äî</span> av 150 arter</span>
            </div>
            <div class="thermometer">
                <div class="thermometer-scale">
                    <span class="scale-mark" style="left: 0%">0</span>
                    <span class="scale-mark" style="left: 33%">50</span>
                    <span class="scale-mark" style="left: 66%">100</span>
                    <span class="scale-mark" style="left: 100%">150</span>
                </div>
                <div class="thermometer-bar">
                    <div class="thermometer-fill" id="progress-fill"></div>
                </div>
            </div>
            <div class="latest-species" id="latest-species"></div>
        </div>

        <!-- Senaste notis -->
        {{ $latest := first 1 (where .Site.RegularPages "Section" "posts") }}
        {{ range $latest }}
        <div class="latest-post-preview">
            <h3 class="latest-post-label">Senaste notis</h3>
            <a href="{{ .RelPermalink }}" class="latest-post-card">
                <div class="latest-post-content">
                    <span class="latest-post-date">{{ .Date | time.Format "2 Jan" }}</span>
                    <h4 class="latest-post-title">{{ .Title }}</h4>
                    <p class="latest-post-summary">{{ .Summary | truncate 100 }}</p>
                </div>
                {{ if .Params.image }}
                <div class="latest-post-image">
                    <img src="{{ .Params.image | relURL }}" alt="">
                </div>
                {{ end }}
                <div class="latest-post-arrow">‚Üí</div>
            </a>
        </div>
        {{ end }}

        <!-- Observationssp√•r / Tidslinje -->
        <div class="observation-trail">
            <h2 class="trail-title">Observationssp√•r</h2>
            <div class="trail-timeline" id="trail-timeline">
                <!-- Fylls av JavaScript -->
            </div>
        </div>

        <!-- Navigeringsalternativ -->
        <nav class="hero-nav">
            <a href="{{ `arslista/` | relURL }}" class="nav-card">
                <span class="nav-label">Artlista</span>
                <span class="nav-desc">Alla observerade arter</span>
            </a>
            <a href="{{ `karta/` | relURL }}" class="nav-card">
                <span class="nav-label">Karta</span>
                <span class="nav-desc">Var arterna hittats</span>
            </a>
            <a href="{{ `posts/` | relURL }}" class="nav-card">
                <span class="nav-label">Notiser</span>
                <span class="nav-desc">Ber√§ttelser fr√•n f√§lt</span>
            </a>
        </nav>
    </div>
</section>
{{ end }}

{{ define "scripts" }}
<script>
    const YEAR_GOAL = 150;

    // Mappa datum till notiser (genereras av Hugo)
    const postsByDate = {};
    { { $allPosts:= where.Site.RegularPages "Section" "posts" } }
    { { range $allPosts } }
    postsByDate["{{ .Date.Format "2006-01-02" }}"] = "{{ .RelPermalink }}";
    { { end } }

    fetch('{{ `data/checklist-2026.json` | relURL }}')
        .then(r => r.json())
        .then(data => {
            const uniqueSpecies = new Set(data.observations.map(o => o.species));
            const speciesCount = uniqueSpecies.size;

            document.getElementById('species-count').textContent = speciesCount;

            const percentage = (speciesCount / YEAR_GOAL) * 100;
            const fill = document.getElementById('progress-fill');
            fill.style.width = Math.min(percentage, 100) + '%';

            // Dynamisk f√§rg justerad f√∂r att vara mer gul l√§ngre
            const hue = 45 + (percentage / 100) * 60;
            const saturation = 90;
            const lightness = 55;
            fill.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

            // Visa senaste kryssade art
            if (data.observations.length > 0) {
                const latest = data.observations[data.observations.length - 1];
                const latestEl = document.getElementById('latest-species');
                latestEl.innerHTML = `<span class="latest-label">Senast kryssad:</span> <strong>${latest.species}</strong> <span class="latest-meta">(${latest.location}, ${new Date(latest.date).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' })})</span>`;
            }

            // Bygg observationssp√•r (tidslinje)
            const byDate = {};
            data.observations.forEach(obs => {
                if (!byDate[obs.date]) {
                    byDate[obs.date] = { species: [], locations: new Set() };
                }
                byDate[obs.date].species.push(obs.species);
                byDate[obs.date].locations.add(obs.location);
            });

            const dates = Object.keys(byDate).sort((a, b) => new Date(b) - new Date(a));
            const trailEl = document.getElementById('trail-timeline');

            trailEl.innerHTML = dates.map((date, i) => {
                const info = byDate[date];
                const dateObj = new Date(date);
                const day = dateObj.getDate();
                const month = dateObj.toLocaleDateString('sv-SE', { month: 'short' });
                const locations = [...info.locations].join(', ');
                const isLast = i === dates.length - 1;

                // Kolla om det finns en notis f√∂r detta datum
                const postLink = postsByDate[date];
                const dateHtml = postLink
                    ? `<a href="${postLink}" class="trail-date has-post" title="L√§s notis">
                         <span class="trail-day">${day}</span> 
                         <span class="trail-month">${month}</span>
                         <span class="trail-icon">üìù</span>
                       </a>`
                    : `<div class="trail-date">
                         <span class="trail-day">${day}</span> 
                         <span class="trail-month">${month}</span>
                       </div>`;

                return `
                    <div class="trail-item ${i === 0 ? 'trail-item-latest' : ''}">
                        <div class="trail-line ${isLast ? 'trail-line-end' : ''}"></div>
                        <div class="trail-dot"></div>
                        <div class="trail-content">
                            ${dateHtml}
                            <div class="trail-details">
                                <div class="trail-species">${info.species.join(', ')}</div>
                                <div class="trail-location">${locations}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        })
        .catch(console.error);
</script>
{{ end }}