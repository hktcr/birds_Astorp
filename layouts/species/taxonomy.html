{{ define "main" }}
{{/* Only species taxonomy gets the atlas treatment */}}
{{ if eq .Data.Plural "species" }}

<div class="atlas-page">
    <div class="atlas-disclaimer">
        üî¨ <em>F√•gelatlasen f√∂r √Östorps kommun √§r ett p√•g√•ende projekt under utveckling. Data och inneh√•ll byggs upp
            successivt under f√•gel√•ret 2026.</em>
    </div>

    <div class="atlas-header">
        <h1 class="atlas-title">F√•gelatlasen</h1>
        <p class="atlas-subtitle">En sj√§lvbyggande f√•gelbok f√∂r √Östorps kommun ‚Äî art f√∂r art, driven av f√§ltdagboken</p>
    </div>

    {{/* Build a lookup map of existing taxonomy term pages */}}
    {{ $termPages := dict }}
    {{ range .Pages }}
    {{ $termPages = merge $termPages (dict (lower .Title) .) }}
    {{ end }}

    {{/* Get all checklist species */}}
    {{ $checklist := site.Data.checklist_2026 | default (dict) }}
    {{ $checklistObs := index $checklist "observations" | default slice }}
    {{ $totalSpecies := len $checklistObs }}
    {{ $speciesWithPages := len .Pages }}

    <p class="atlas-count">{{ $totalSpecies }} arter kryssade under f√•gel√•ret ¬∑ {{ $speciesWithPages }} har egna
        atlassidor</p>

    <!-- Search/filter -->
    <div class="atlas-search-bar">
        <input type="text" id="atlas-search" class="atlas-search-input" placeholder="S√∂k art..." autocomplete="off">
    </div>

    {{/* Collect first image per species from posts */}}
    {{ $speciesImages := dict }}
    {{ range .Pages }}
    {{ $speciesName := lower .Title }}
    {{ if not (index $speciesImages $speciesName) }}
    {{ range .Pages }}
    {{ if not (index $speciesImages $speciesName) }}
    {{ $content := .RawContent }}
    {{ $imgRegex := `<img[^>]+src=["']([^"']+)["'][^>]*>` }}
        {{ $mdRegex := `!\[.*?\]\((.*?)\)` }}
        {{ range (findRE $imgRegex $content) }}
        {{ if not (index $speciesImages $speciesName) }}
        {{ $url := replaceRE `.*src=["']([^"']+)["'].*` "$1" . }}
        {{ if not (in $url "hitta-hit") }}
        {{ $speciesImages = merge $speciesImages (dict $speciesName $url) }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ if not (index $speciesImages $speciesName) }}
        {{ range (findRE $mdRegex $content) }}
        {{ if not (index $speciesImages $speciesName) }}
        {{ $url := replaceRE `!\[.*?\]\((.*?)\)` "$1" . }}
        {{ if not (in $url "hitta-hit") }}
        {{ $speciesImages = merge $speciesImages (dict $speciesName $url) }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ end }}

        <div class="atlas-grid" id="atlas-grid">
            {{/* Iterate over all checklist species */}}
            {{ range $checklistObs }}
            {{ $name := .species }}
            {{ $slug := $name | urlize }}
            {{ $nameLower := lower $name }}
            {{ $termPage := index $termPages $nameLower }}
            {{ $thumbUrl := index $speciesImages $nameLower }}

            {{ if $termPage }}
            <a href="{{ $termPage.Permalink }}" class="atlas-card" data-name="{{ $nameLower }}">
                {{ else }}
                <div class="atlas-card atlas-card-pending" data-name="{{ $nameLower }}">
                    {{ end }}
                    {{ if $thumbUrl }}
                    <div class="atlas-card-thumb">
                        <img src="{{ $thumbUrl }}" alt="{{ $name }}" loading="lazy">
                    </div>
                    {{ else }}
                    <div class="atlas-card-thumb atlas-card-no-image">
                        <span>üê¶</span>
                    </div>
                    {{ end }}
                    <div class="atlas-card-info">
                        <span class="atlas-card-name">{{ $name }}</span>
                        {{ if $termPage }}
                        <span class="atlas-card-count">{{ len $termPage.Pages }} {{ if eq (len $termPage.Pages) 1
                            }}notis{{ else }}notiser{{ end }}</span>
                        {{ else }}
                        <span class="atlas-card-count atlas-card-awaiting">Kryssad {{ .date }}</span>
                        {{ end }}
                    </div>
                    {{ if $termPage }}
            </a>
            {{ else }}
        </div>
        {{ end }}
        {{ end }}
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const search = document.getElementById('atlas-search');
        const cards = document.querySelectorAll('.atlas-card');

        search.addEventListener('input', () => {
            const q = search.value.toLowerCase().trim();
            cards.forEach(card => {
                const name = card.getAttribute('data-name');
                card.style.display = (!q || name.includes(q)) ? '' : 'none';
            });
        });
    });
</script>

{{ else }}
{{/* Default taxonomy list for non-species taxonomies */}}
<div class="container py-4 py-md-5">
    <h1>{{ .Title }}</h1>
    <ul>
        {{ range .Pages }}
        <li><a href="{{ .Permalink }}">{{ .Title }}</a> ({{ len .Pages }})</li>
        {{ end }}
    </ul>
</div>
{{ end }}
{{ end }}