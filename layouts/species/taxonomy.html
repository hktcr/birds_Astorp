{{ define "main" }}
{{ if eq .Data.Plural "species" }}

<div class="atlas-page">

    {{/* ── DATA SOURCES ── */}}
    {{ $checklist := site.Data.checklist_2026 | default (dict) }}
    {{ $checklistObs := index $checklist "observations" | default slice }}
    {{ $portraits := site.Data.species_portraits | default (dict) }}
    {{ $portraitMap := index $portraits "portraits" | default (dict) }}
    {{ $guide := site.Data.species_guide | default (dict) }}
    {{ $guideSpecies := index $guide "species" | default slice }}

    {{/* Build checklist lookup */}}
    {{ $tickedNames := slice }}
    {{ $tickDates := dict }}
    {{ $tickNumbers := dict }}
    {{ $counter := 0 }}
    {{ range $checklistObs }}
    {{ $counter = add $counter 1 }}
    {{ $tickedNames = $tickedNames | append .species }}
    {{ $tickDates = merge $tickDates (dict .species .date) }}
    {{ $tickNumbers = merge $tickNumbers (dict .species $counter) }}
    {{ end }}

    {{/* Build taxonomy term page lookup */}}
    {{ $termPages := dict }}
    {{ range .Pages }}
    {{ $termPages = merge $termPages (dict .Title .) }}
    {{ end }}

    {{/* ── DISCLAIMER BANNER ── */}}
    <div class="atlas-disclaimer">
        <span class="atlas-icon atlas-icon--flask"></span>
        <em>Fågelatlasen för Åstorps kommun är ett pågående projekt under utveckling. Data och innehåll byggs upp
            successivt under fågelåret 2026.</em>
    </div>

    {{/* ── HERO SECTION ── */}}
    <div class="atlas-hero">
        <div class="atlas-hero-inner">
            <h1 class="atlas-title">Fågelatlasen</h1>
            <p class="atlas-subtitle">En självbyggande fågelbok för Åstorps kommun — art för art, driven av
                fältdagboken</p>
            <div class="atlas-hero-stats">
                <div class="atlas-hero-stat">
                    <span class="atlas-hero-number">{{ len $tickedNames }}</span>
                    <span class="atlas-hero-label">kryssade</span>
                </div>
                <div class="atlas-hero-divider"></div>
                <div class="atlas-hero-stat">
                    <span class="atlas-hero-number atlas-hero-number--muted">150</span>
                    <span class="atlas-hero-label">mål</span>
                </div>
            </div>
        </div>
    </div>

    {{/* ── SEARCH BAR ── */}}
    <div class="atlas-search-bar">
        <span class="atlas-icon atlas-icon--search"></span>
        <input type="text" id="atlas-search" class="atlas-search-input" placeholder="Sök art..." autocomplete="off">
    </div>

    {{/* ── SECTION: Kryssade arter ── */}}
    <h2 class="atlas-section-title">
        <span class="atlas-icon atlas-icon--check"></span>
        Kryssade 2026
    </h2>
    <div class="atlas-grid" id="atlas-grid-ticked">
        {{ range $checklistObs }}
        {{ $name := .species }}
        {{ $termPage := index $termPages $name }}
        {{ $portrait := index $portraitMap $name }}
        {{ $num := index $tickNumbers $name }}

        <a href="{{ with $termPage }}{{ .Permalink }}{{ end }}" class="atlas-card atlas-card--ticked"
            data-name="{{ lower $name }}">
            {{ if $portrait }}
            <div class="atlas-card-thumb">
                <img src="{{ $portrait }}" alt="{{ $name }}" loading="lazy">
                <div class="atlas-card-overlay">
                    <span class="atlas-card-overlay-name">{{ $name }}</span>
                </div>
            </div>
            {{ else }}
            <div class="atlas-card-thumb atlas-card-text-placeholder">
                <span>{{ $name }}</span>
            </div>
            {{ end }}
            <div class="atlas-card-badge">#{{ $num }}</div>
            <div class="atlas-card-info">
                <span class="atlas-card-name">{{ $name }}</span>
                {{ with $termPage }}
                {{ $postCount := sub (len .Pages) 1 }}
                {{ if gt $postCount 0 }}
                <span class="atlas-card-count">{{ $postCount }} {{ if eq $postCount 1 }}notis{{ else }}notiser{{ end
                    }}</span>
                {{ else }}
                <span class="atlas-card-count atlas-card-awaiting">Kryssad {{ index $tickDates $name }}</span>
                {{ end }}
                {{ end }}
            </div>
        </a>
        {{ end }}
    </div>

    {{/* ── SECTION: Övriga arter ── */}}
    <h2 class="atlas-section-title atlas-section-divider">
        <span class="atlas-icon atlas-icon--list"></span>
        Övriga arter i Åstorps kommun
    </h2>
    <div class="atlas-grid" id="atlas-grid-all">
        {{ range $guideSpecies }}
        {{ $name := .name }}
        {{ if and (gt .total 0) (not (in $tickedNames $name)) }}
        {{ $termPage := index $termPages $name }}

        <a href="{{ with $termPage }}{{ .Permalink }}{{ end }}" class="atlas-card atlas-card-pending"
            data-name="{{ lower $name }}">
            <div class="atlas-card-thumb atlas-card-text-placeholder atlas-card-text-muted">
                <span>{{ $name }}</span>
            </div>
            <div class="atlas-card-info">
                <span class="atlas-card-name">{{ $name }}</span>
                <span class="atlas-card-count atlas-card-awaiting">{{ .total }} rapporter</span>
            </div>
        </a>
        {{ end }}
        {{ end }}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const search = document.getElementById('atlas-search');
        const cards = document.querySelectorAll('.atlas-card');

        // Fade-in animation
        cards.forEach((card, i) => {
            card.style.animationDelay = `${Math.min(i * 30, 600)}ms`;
            card.classList.add('atlas-card--animate');
        });

        search.addEventListener('input', () => {
            const q = search.value.toLowerCase().trim();
            cards.forEach(card => {
                const name = card.getAttribute('data-name');
                card.style.display = (!q || name.includes(q)) ? '' : 'none';
            });
            // Show/hide section titles
            document.querySelectorAll('.atlas-section-title').forEach(h => {
                if (!q) { h.style.display = ''; return; }
                const grid = h.nextElementSibling;
                if (grid) {
                    const visible = grid.querySelectorAll('.atlas-card:not([style*="none"])');
                    h.style.display = visible.length ? '' : 'none';
                }
            });
        });
    });
</script>

{{ else }}
<div class="container py-4 py-md-5">
    <h1>{{ .Title }}</h1>
    <ul>
        {{ range .Pages }}<li><a href="{{ .Permalink }}">{{ .Title }}</a> ({{ len .Pages }})</li>{{ end }}
    </ul>
</div>
{{ end }}
{{ end }}