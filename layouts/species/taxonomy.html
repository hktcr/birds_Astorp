{{ define "main" }}
{{ if eq .Data.Plural "species" }}

<div class="atlas-page">
    <div class="atlas-disclaimer">
        üî¨ <em>F√•gelatlasen f√∂r √Östorps kommun √§r ett p√•g√•ende projekt under utveckling. Data och inneh√•ll byggs upp
            successivt under f√•gel√•ret 2026.</em>
    </div>

    <div class="atlas-header">
        <h1 class="atlas-title">F√•gelatlasen</h1>
        <p class="atlas-subtitle">En sj√§lvbyggande f√•gelbok f√∂r √Östorps kommun ‚Äî art f√∂r art, driven av f√§ltdagboken</p>
    </div>

    {{/* Get all checklist species */}}
    {{ $checklist := site.Data.checklist_2026 | default (dict) }}
    {{ $checklistObs := index $checklist "observations" | default slice }}
    {{ $totalSpecies := len $checklistObs }}

    {{/* Build lookup of taxonomy term pages */}}
    {{ $termPages := dict }}
    {{ range .Pages }}
    {{ $termPages = merge $termPages (dict (lower .Title) .) }}
    {{ end }}

    <p class="atlas-count">{{ $totalSpecies }} arter kryssade under f√•gel√•ret</p>

    <div class="atlas-search-bar">
        <input type="text" id="atlas-search" class="atlas-search-input" placeholder="S√∂k art..." autocomplete="off">
    </div>

    <div class="atlas-grid" id="atlas-grid">
        {{ range $checklistObs }}
        {{ $name := .species }}
        {{ $nameLower := lower $name }}
        {{ $termPage := index $termPages $nameLower }}
        {{ $postCount := 0 }}
        {{ with $termPage }}
        {{/* Subtract 1 for the hidden artregister page */}}
        {{ $rawCount := len .Pages }}
        {{ $postCount = sub $rawCount 1 }}
        {{ if lt $postCount 0 }}{{ $postCount = 0 }}{{ end }}
        {{ end }}

        <a href="{{ with $termPage }}{{ .Permalink }}{{ end }}"
            class="atlas-card{{ if eq $postCount 0 }} atlas-card-pending{{ end }}" data-name="{{ $nameLower }}">
            <div class="atlas-card-thumb atlas-card-text-placeholder">
                <span>{{ $name }}</span>
            </div>
            <div class="atlas-card-info">
                <span class="atlas-card-name">{{ $name }}</span>
                {{ if gt $postCount 0 }}
                <span class="atlas-card-count">{{ $postCount }} {{ if eq $postCount 1 }}notis{{ else }}notiser{{ end
                    }}</span>
                {{ else }}
                <span class="atlas-card-count atlas-card-awaiting">Kryssad {{ .date }}</span>
                {{ end }}
            </div>
        </a>
        {{ end }}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const search = document.getElementById('atlas-search');
        const cards = document.querySelectorAll('.atlas-card');
        search.addEventListener('input', () => {
            const q = search.value.toLowerCase().trim();
            cards.forEach(card => {
                const name = card.getAttribute('data-name');
                card.style.display = (!q || name.includes(q)) ? '' : 'none';
            });
        });
    });
</script>

{{ else }}
<div class="container py-4 py-md-5">
    <h1>{{ .Title }}</h1>
    <ul>
        {{ range .Pages }}
        <li><a href="{{ .Permalink }}">{{ .Title }}</a> ({{ len .Pages }})</li>
        {{ end }}
    </ul>
</div>
{{ end }}
{{ end }}